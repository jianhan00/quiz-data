<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç·šä¸Šåˆ·é¡Œå°ç¨‹åº</title>
<style>
:root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#64748b;--brand:#3b82f6;--ok:#16a34a;--bad:#ef4444;--line:#e5e7eb}
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:1000px;margin:24px auto;padding:0 16px}.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.06);padding:18px}
h1{margin:0 0 8px;font-size:28px}.sub{color:var(--muted);font-size:13px}.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button,select{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff;color:var(--ink);font-size:16px;cursor:pointer}
.btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}.btn.ghost{background:#fff}
.badge{background:#f1f5f9;border:1px solid var(--line);border-radius:12px;padding:8px 12px;font-size:16px;margin-right:8px}.hr{height:1px;background:var(--line);margin:14px 0}
.question{font-size:22px;line-height:1.7;margin:8px 0 10px}
.opt{display:flex;align-items:flex-start;gap:10px;border:1px solid var(--line);border-radius:12px;padding:8px 10px;margin:4px 0;font-size:18px;background:#fff;cursor:pointer}
.opt:hover{background:#f8fafc}
.opt.correct{border-color:var(--ok);background:#f0fdf4}.opt.wrong{border-color:var(--bad);background:#fef2f2}
.feedback{margin-top:10px;border:1px solid var(--line);border-radius:10px;padding:10px;font-size:17px;background:#f8fafc}
.feedback.ok{color:var(--ok)}.feedback.bad{color:var(--bad)}
.nav{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.chips{display:flex;gap:10px;flex-wrap:wrap}.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);background:#eef2ff;border-radius:999px;font-size:16px;cursor:pointer}
.chip input{width:18px;height:18px;cursor:pointer}
.report{margin-top:14px;border:1px solid var(--line);background:#fff;border-radius:12px;padding:14px}
.hidden{display:none}
@media(max-width:600px){h1{font-size:24px}.question{font-size:20px}.opt{font-size:17px}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ç·šä¸Šåˆ·é¡Œå°ç¨‹åº <span class="sub">â€” é›²ç«¯ç‰ˆ</span></h1>
  </div>
  <div class="card" id="panel-student">è¼‰å…¥é¡Œåº«ä¸­...</div>
</div>

<script>
const $ = s => document.querySelector(s);
const isArray = Array.isArray;
function normalize(a){ if(a==null) return []; return isArray(a)? [...a].sort((x,y)=>x-y) : [a]; }
function same(a,b){ a=normalize(a); b=normalize(b); return a.length===b.length && a.every((v,i)=>v===b[i]); }
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }

let BANK = [];

async function init(){
  try {
    const r = await fetch('questions.json?t=' + new Date().getTime()); 
    if(!r.ok) throw new Error('è®€å–å¤±æ•—');
    BANK = await r.json();
    mountStudent('#panel-student');
  } catch(e) {
    $('#panel-student').innerHTML = `<p style="color:red">è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª questions.json æ˜¯å¦å­˜åœ¨ã€‚</p>`;
  }
}

function mountStudent(selector){
  const el = $(selector);
  el.innerHTML=`
    <div class="row">
      <div class="badge">å…± <b class="s-total">${BANK.length}</b> é¡Œ</div>
      <div class="badge">ç›®å‰ï¼š<b class="s-progress">0/0</b></div>
      <div class="badge">å·²ç­”å°ï¼š<b class="s-right">0</b></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div style="font-size:16px;font-weight:bold">ç« ç¯€ï¼š</div>
      <div class="chips s-sections"></div>
    </div>
    <div class="hr"></div>
    <div class="row">
      <label>æ¨¡å¼</label>
      <select class="s-mode"><option value="order">ä¾é †åº</option><option value="shuffle">éš¨æ©Ÿ</option></select>
      <label>é¡Œæ•¸</label>
      <select class="s-count"><option value="10" selected>10</option><option value="20">20</option><option value="50">50</option><option value="all">å…¨éƒ¨</option></select>
      <button class="btn brand s-start">é–‹å§‹ä½œç­”</button>
      <button class="btn ghost s-reset">é‡ç½®</button>
      <button class="btn ghost s-finish" disabled>å®Œæˆä¸¦çœ‹æˆç¸¾</button>
    </div>
    <div class="hr"></div>
    <div class="question s-q">è«‹é¸æ“‡ç« ç¯€èˆ‡é¡Œæ•¸å¾Œï¼ŒæŒ‰ã€Œé–‹å§‹ä½œç­”ã€</div>
    <div class="s-optBox"></div>
    <div class="feedback s-fb hidden">
      <div class="s-fbTitle" style="font-weight:bold"></div>
      <div class="s-fbAns"></div>
      <div class="s-fbExp"></div>
    </div>
    <div class="nav hidden s-nav">
      <button class="btn s-prev">â† ä¸Šä¸€é¡Œ</button>
      <button class="btn s-next">ä¸‹ä¸€é¡Œ â†’</button>
    </div>
    <div class="report hidden s-report"></div>
  `;
  
  const state = {paper:[], idx:0, right:0, user:{}, revealed:{}, firstScored:{}};
  el._state = state;
  
  const secs = [...new Set(BANK.map(q => q.section||'æœªåˆ†é¡'))];
  el.querySelector('.s-sections').innerHTML = secs.map(s => `
    <label class="chip"><input type="checkbox" value="${s}" checked> ${s}</label>
  `).join('');

  el.querySelector('.s-start').onclick = () => start(el);
  el.querySelector('.s-reset').onclick = () => mountStudent(selector); 
  el.querySelector('.s-prev').onclick = () => { if(state.idx>0){ state.idx--; render(el); } };
  el.querySelector('.s-next').onclick = () => { 
    if(state.idx < state.paper.length-1){ state.idx++; render(el); }
    else { showReport(el); }
  };
  el.querySelector('.s-finish').onclick = () => showReport(el);
}

function start(root){
  const st = root._state;
  const mode = root.querySelector('.s-mode').value;
  const wantStr = root.querySelector('.s-count').value;
  const chosen = [...root.querySelectorAll('.s-sections input:checked')].map(i=>i.value);
  
  if(!chosen.length) return alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ç« ç¯€');
  
  const poolIdx = BANK.map((q,i)=>({q,i})).filter(x => chosen.includes(x.q.section||'æœªåˆ†é¡')).map(x=>x.i);
  if(!poolIdx.length) return alert('æ‰€é¸ç« ç¯€ç›®å‰æ²’æœ‰é¡Œç›®');
  
  let list = (mode==='shuffle') ? shuffle(poolIdx) : poolIdx;
  const want = (wantStr==='all') ? list.length : Math.min(parseInt(wantStr), list.length);
  
  st.paper = list.slice(0, want);
  st.idx = 0; st.right = 0; st.user = {}; st.revealed = {}; st.firstScored = {};
  
  root.querySelector('.s-finish').disabled = false;
  root.querySelector('.s-nav').classList.remove('hidden');
  render(root);
}

function render(root){
  const st = root._state;
  const pi = st.paper[st.idx];
  const q = BANK[pi];
  
  root.querySelector('.s-progress').textContent = `${st.idx+1}/${st.paper.length}`;
  root.querySelector('.s-right').textContent = st.right;
  root.querySelector('.s-q').textContent = q.question;
  
  const box = root.querySelector('.s-optBox');
  box.innerHTML = '';
  const correct = normalize(q.answer);
  const isMulti = correct.length > 1;
  const cur = normalize(st.user[pi]);
  
  (q.options||[]).forEach((opt, i) => {
    const row = document.createElement('label'); 
    row.className = 'opt';
    const ip = document.createElement('input'); 
    ip.type = isMulti ? 'checkbox' : 'radio';
    ip.name = 'q_opt';
    ip.checked = cur.includes(i);
    
    row.onclick = (e) => {
      if(e.target !== ip) ip.checked = !ip.checked;
      
      let now = new Set(normalize(st.user[pi]));
      if(isMulti){
        if(ip.checked) now.add(i); else now.delete(i);
      } else {
        now = new Set([i]);
        box.querySelectorAll('input').forEach((inp, idx) => { if(idx!==i) inp.checked=false; });
      }
      st.user[pi] = [...now].sort((a,b)=>a-b);
      
      const uAns = st.user[pi];
      const right = same(uAns, q.answer);
      if(!isMulti || uAns.length >= correct.length){
         st.revealed[pi] = true;
         if(right && !st.firstScored[pi]){ st.right++; st.firstScored[pi]=true; }
         refreshUI(root, q, pi);
      }
    };
    row.append(ip, document.createTextNode(" " + opt));
    box.append(row);
  });
  
  refreshUI(root, q, pi);
}

function refreshUI(root, q, pi){
  const st = root._state;
  const isRev = st.revealed[pi];
  const uAns = normalize(st.user[pi]);
  const correct = normalize(q.answer);
  const ok = same(uAns, q.answer);
  
  const fb = root.querySelector('.s-fb');
  if(isRev){
    fb.classList.remove('hidden');
    fb.className = `feedback s-fb ${ok?'ok':'bad'}`;
    root.querySelector('.s-fbTitle').textContent = ok ? 'ç­”å°äº† âœ…' : 'ç­”éŒ¯äº† âŒ';
    root.querySelector('.s-fbAns').textContent = 'æ­£ç¢ºç­”æ¡ˆï¼š' + correct.map(i=>['A','B','C','D'][i]).join(', ');
    root.querySelector('.s-fbExp').textContent = q.explanation || '';
    
    root.querySelectorAll('.opt').forEach((row, i) => {
      row.classList.remove('correct','wrong');
      if(correct.includes(i)) row.classList.add('correct');
      else if(uAns.includes(i)) row.classList.add('wrong');
    });
  } else {
    fb.classList.add('hidden');
  }
}

function showReport(root){
  const st = root._state;
  const box = root.querySelector('.s-report');
  box.classList.remove('hidden');
  const wrongList = st.paper.filter(pi => !same(st.user[pi], BANK[pi].answer));
  
  box.innerHTML = `
    <h3>æˆç¸¾å ±å‘Š</h3>
    <div style="margin-bottom:10px">
       <span class="chip">ç­”å°ï¼š${st.right} / ${st.paper.length}</span>
       <span class="chip">æ­£ç¢ºç‡ï¼š${Math.round(st.right/st.paper.length*100)}%</span>
    </div>
    ${wrongList.length===0 ? '<p>å…¨å°ï¼å¤ªæ£’äº† ğŸ‰</p>' : 
      `<details open><summary>éŒ¯é¡Œæ¸…å–® (${wrongList.length})</summary>
       <ul>${wrongList.map(pi => {
         const q = BANK[pi];
         return `<li><b>${q.question}</b><br><span class="sub">è§£æï¼š${q.explanation||'ç„¡'}</span></li>`;
       }).join('')}</ul></details>`
    }
    <button class="btn brand" onclick="mountStudent('#panel-student')">å†ç©ä¸€æ¬¡</button>
  `;
  root.querySelector('.s-nav').classList.add('hidden');
  root.querySelector('.s-optBox').innerHTML = '';
  root.querySelector('.s-q').textContent = 'æ¸¬é©—çµæŸ';
}
init();
</script>
</body>
</html>